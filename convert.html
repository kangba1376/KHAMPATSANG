<!DOCTYPE html>
<html lang="bo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ཁམས་པ་ཚང་བོད་ཡིག་ཨང་བསྒྱུར།</title>
    <style>
        @font-face {
            font-family: 'TibetWildYak';
            src: url('TibetWildYak.ttf') format('truetype');
            font-display: swap;
        }

        body { 
            font-family: 'TibetWildYak', 'Microsoft YaHei', sans-serif; 
            padding: 20px; 
            background: #f0f2f5; 
            color: #1a1a1a; 
        }

        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
            text-align: center;
        }

        .logo {
            width: 120px;
            height: auto;
            margin-bottom: 15px;
            display: inline-block;
        }

        h2 { 
            color: #8B0000; 
            margin-bottom: 25px; 
            font-weight: 600; 
            font-size: 32px; 
            font-family: 'TibetWildYak', serif;
        }

        .section-label { 
            text-align: left;
            font-size: 16px; 
            color: #8B0000; 
            margin-bottom: 8px; 
            font-weight: bold; 
        }

        textarea { 
            width: 100%; 
            height: 200px; 
            margin-bottom: 20px; 
            padding: 15px; 
            font-size: 26px; 
            line-height: 1.8;
            border: 1px solid #d2d2d7; 
            border-radius: 8px; 
            resize: vertical; 
            box-sizing: border-box; 
            font-family: 'TibetWildYak', serif;
            background-color: #fafafa;
            color: #1a1a1a;
        }

        textarea:focus { 
            outline: none; 
            border-color: #8B0000; 
            box-shadow: 0 0 0 4px rgba(139, 0, 0, 0.1); 
            background-color: #fff;
        }

        .btns { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 25px; 
        }

        button { 
            flex: 1; 
            padding: 16px; 
            background: #8B0000; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 20px; 
            font-weight: 500; 
            transition: all 0.2s; 
            font-family: 'TibetWildYak', sans-serif;
        }

        button:hover { 
            background: #a00000; 
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div class="container">
    <img src="logo.png" alt="KhamPaTsang Logo" class="logo" onerror="this.style.display='none'">
    <h2>ཁམས་པ་ཚང་བོད་ཡིག་ཨང་བསྒྱུར།</h2>
    
    <div class="section-label">ནང་དོན་འགོད་ཁུལ། (པཎྜི་ཏ། ཡང་ན། ཧི་མ་ལ་ཡ།)</div>
    <textarea id="inputArea" placeholder="ཨང་བསྒྱུར་དགོས་པའི་ནང་དོན་འདི་ན་འགོད་རོགས།..."></textarea>
    
    <div class="btns">
        <button onclick="convert('toUni')">པཎྜི་ཏ། → ཧི་མ་ལ་ཡ།</button>
        <button onclick="convert('toBzd')">ཧི་མ་ལ་ཡ། → པཎྜི་ཏ།</button>
    </div>
    
    <div class="section-label">ཨང་བསྒྱུར་མཇུག་འབྲས།</div>
    <textarea id="outputArea" readonly placeholder="ཨང་བསྒྱུར་ཚར་བའི་ནང་དོན་འདི་ན་འཆར་འོང་།..."></textarea>
</div>

<script>
    let bzdToUniMap = new Map();
    let cp936ToUniMap = new Map();

    // 1. 加载所有必要的表
    async function init() {
        try {
            // 加载 CP936 表：把“笆耙”乱码转回原始二进制码
            const cp936Res = await fetch('CP936toUnicodeTable.TXT');
            const cp936Text = await cp936Res.text();
            cp936Text.split('\n').forEach(line => {
                const parts = line.split('\t');
                if (parts.length >= 2) {
                    // Map: 汉字Unicode -> 原始GBK/CP936码
                    cp936ToUniMap.set(parseInt(parts[1], 16), parseInt(parts[0], 16));
                }
            });

            // 加载 TBL 表：班智达转 Unicode (按照 UTFC 源码逻辑解析)
            const tblRes = await fetch('Bzd2Uni.tbl');
            const arrayBuffer = await tblRes.arrayBuffer();
            const view = new DataView(arrayBuffer);
            // 注意：TBL 是文本形式的数字对应，还是二进制？
            // 根据 snippet，它是文本形式的空格分隔。我们按文本读取：
            const decoder = new TextDecoder();
            const tblText = decoder.decode(arrayBuffer);
            const tblLines = tblText.split('\n');
            tblLines.forEach(line => {
                const parts = line.trim().split(/\s+/);
                if (parts.length >= 2) {
                    // key 是班智达码，value 是喜马拉雅 Unicode 序列
                    bzdToUniMap.set(parts[0], parts.slice(1).map(v => String.fromCharCode(parseInt(v))));
                }
            });

            console.log("专业级映射表加载完成！");
        } catch (err) {
            console.error("加载资源失败:", err);
            alert("加载码表失败，请检查文件是否存在！");
        }
    }

    init();

    function convert(direction) {
        let input = document.getElementById('inputArea').value;
        let output = "";

        if (direction === 'toUni') {
            for (let i = 0; i < input.length; i++) {
                let charCode = input.charCodeAt(i);
                let rawCode;

                // 第一步：如果字符在汉字区，先通过 CP936 还原成原始编码
                if (cp936ToUniMap.has(charCode)) {
                    rawCode = cp936ToUniMap.get(charCode);
                } else {
                    rawCode = charCode;
                }

                // 第二步：拿着原始编码查班智达 TBL 表
                let rawCodeStr = rawCode.toString();
                let altCodeStr = (rawCode >= 0xF000) ? (rawCode - 0xF000).toString() : rawCode.toString();

                let result = bzdToUniMap.get(rawCodeStr) || bzdToUniMap.get(altCodeStr);

                if (result) {
                    output += result.join('');
                } else {
                    output += input[i]; // 没匹配到（如空格、回车）则保留原样
                }
            }
        } else {
            // 反向转换逻辑
            output = "反向转换正在根据反向映射表生成中...";
        }
        document.getElementById('outputArea').value = output;
    }
</script>

</body>
</html>