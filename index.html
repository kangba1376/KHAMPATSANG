<!DOCTYPE html>
<html lang="bo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ཁམས་པ་ཚང་བོད་ཡིག་ཨང་བསྒྱུར།</title>
    <style>
        /* 引入你的 TibetWildYak 字体 */
        @font-face {
            font-family: 'TibetWildYak';
            src: url('TibetWildYak.ttf') format('truetype');
            font-display: swap;
        }

        body { 
            font-family: 'TibetWildYak', 'Microsoft YaHei', sans-serif; 
            padding: 20px; 
            background: #f0f2f5; 
            color: #1a1a1a; 
        }

        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
            text-align: center;
        }

        /* Logo 样式 */
        .logo {
            width: 120px;
            height: auto;
            margin-bottom: 15px;
            display: inline-block;
        }

        /* 标题颜色：深红色 */
        h2 { 
            color: #8B0000; 
            margin-bottom: 25px; 
            font-weight: 600; 
            font-size: 32px; 
            font-family: 'TibetWildYak', serif;
        }

        /* 标签颜色：深红色 */
        .section-label { 
            text-align: left;
            font-size: 16px; 
            color: #8B0000; 
            margin-bottom: 8px; 
            font-weight: bold; 
        }

        /* 输入框和结果框：文字保持黑色，方便阅读 */
        textarea { 
            width: 100%; 
            height: 200px; 
            margin-bottom: 20px; 
            padding: 15px; 
            font-size: 26px; 
            line-height: 1.8;
            border: 1px solid #d2d2d7; 
            border-radius: 8px; 
            resize: vertical; 
            box-sizing: border-box; 
            font-family: 'TibetWildYak', serif;
            background-color: #fafafa;
            color: #1a1a1a; /* 黑色文字 */
        }

        textarea:focus { 
            outline: none; 
            border-color: #8B0000; /* 焦点框也改为深红 */
            box-shadow: 0 0 0 4px rgba(139, 0, 0, 0.1); 
            background-color: #fff;
        }

        .btns { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 25px; 
        }

        /* 按钮样式：背景深红，文字白色（或者你希望按钮文字也是深红？） */
        /* 这里设定为按钮背景深红，保持醒目 */
        button { 
            flex: 1; 
            padding: 16px; 
            background: #8B0000; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 20px; 
            font-weight: 500; 
            transition: all 0.2s; 
            font-family: 'TibetWildYak', sans-serif;
        }

        button:hover { 
            background: #a00000; 
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* 状态提示颜色：初始也是深红 */
        #status { 
            font-size: 14px; 
            color: #8B0000; 
            margin-bottom: 15px; 
            font-family: 'TibetWildYak', sans-serif;
        }
    </style>
</head>
<body>

<div class="container">
    <img src="logo.png" alt="KhamPaTsang Logo" class="logo" onerror="this.style.display='none'">
    
    <h2>ཁམས་པ་ཚང་བོད་ཡིག་ཨང་བསྒྱུར།</h2>
    <div id="status">ཨང་བསྒྱུར་དྲྭ་མིག་ཁ་སྣོན་བཟོ་བཞིན་པ་ཡིན།...</div>
    
    <div class="section-label">ནང་དོན་འགོད་ཁུལ། (པཎྜི་ཏ། ཡང་ན། ཧི་མ་ལ་ཡ།)</div>
    <textarea id="inputArea" placeholder="ཨང་བསྒྱུར་དགོས་པའི་ནང་དོན་འདི་ན་འགོད་རོགས།..."></textarea>
    
    <div class="btns">
        <button onclick="convert('toUni')">པཎྜི་ཏ། → ཧི་མ་ལ་ཡ།</button>
        <button onclick="convert('toBzd')">ཧི་མ་ལ་ཡ། → པཎྜི་ཏ།</button>
    </div>
    
    <div class="section-label">ཨང་བསྒྱུར་མཇུག་འབྲས།</div>
    <textarea id="outputArea" readonly placeholder="ཨང་བསྒྱུར་ཚར་བའི་ནང་དོན་འདི་ན་འཆར་འོང་།..."></textarea>
</div>

<script>
    let bandridaMap = {};
    let reverseMap = {};

    // 1. 100% 准确地加载码表
    fetch('tibet_master_map.json')
        .then(response => response.json())
        .then(data => {
            bandridaMap = data.Bandrida;
            // 构建反向映射
            for (let bzdKey in bandridaMap) {
                let uniVal = bandridaMap[bzdKey];
                reverseMap[uniVal] = bzdKey;
            }
            console.log("码表加载成功");
        })
        .catch(err => console.error("加载失败:", err));

    function convert(direction) {
        let input = document.getElementById('inputArea').value;
        let output = "";

        if (direction === 'toUni') {
            // 班智达转喜马拉雅 (Unicode)
            for (let i = 0; i < input.length; i++) {
                let codeNum = input.charCodeAt(i);
                
                // 关键点：班智达在网页中输入的字符编码通常在 0xF000 以上
                // 我们尝试匹配原始编码、偏移后的编码
                let codeStr = codeNum.toString();
                let altCodeStr = (codeNum - 61440).toString(); // 处理私有区偏移 (0xF000)

                let targetMatch = bandridaMap[codeStr] || bandridaMap[altCodeStr];

                if (targetMatch) {
                    let codes = targetMatch.split(' ');
                    codes.forEach(c => {
                        output += String.fromCharCode(parseInt(c));
                    });
                } else {
                    output += input[i]; // 没匹配上的保持原样
                }
            }
        } else {
            // 喜马拉雅转班智达 (按字匹配)
            let i = 0;
            while (i < input.length) {
                let matched = false;
                for (let len = 4; len >= 1; len--) {
                    let sub = input.substring(i, i + len);
                    let subCodes = [];
                    for(let j=0; j<sub.length; j++) {
                        subCodes.push(sub.charCodeAt(j).toString());
                    }
                    let key = subCodes.join(' ');
                    if (reverseMap[key]) {
                        // 转换回班智达时，也要考虑到显示，通常需要加回偏移量
                        let bzdBase = parseInt(reverseMap[key]);
                        // 如果编码小于 256，网页显示班智达通常需要加 0xF000
                        let finalCode = bzdBase < 256 ? (bzdBase + 61440) : bzdBase;
                        output += String.fromCharCode(finalCode);
                        i += len;
                        matched = true;
                        break;
                    }
                }
                if (!matched) {
                    output += input[i];
                    i++;
                }
            }
        }
        document.getElementById('outputArea').value = output;
    }
</script>

</body>
</html>
