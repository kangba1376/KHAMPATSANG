<!DOCTYPE html>
<html lang="bo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ཁམས་པ་ཚང་བོད་ཡིག་ཨང་བསྒྱུར།</title>
    <style>
        @font-face { font-family: 'TibetWildYak'; src: url('TibetWildYak.ttf') format('truetype'); }
        :root { --main-red: #8b0000; --white: #fdfaf2; }
        body { font-family: 'TibetWildYak', serif; background: var(--white); display: flex; justify-content: center; padding: 15px; }
        .container { width: 100%; max-width: 800px; background: white; padding: 25px; border-radius: 15px; border-top: 8px solid var(--main-red); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h2 { color: var(--main-red); text-align: center; border-bottom: 2px solid #d4af37; padding-bottom: 10px; }
        .status { text-align: center; color: #666; background: #eee; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
        textarea { width: 100%; height: 200px; border: 2px solid #eee; border-radius: 10px; padding: 15px; font-size: 26px; font-family: 'TibetWildYak', sans-serif; box-sizing: border-box; }
        .btn-box { text-align: center; margin: 25px 0; }
        button { background: var(--main-red); color: white; border: none; padding: 16px 60px; font-size: 24px; border-radius: 50px; cursor: pointer; font-family: 'TibetWildYak'; }
    </style>
</head>
<body>
<div class="container">
    <h2>ཁམས་པ་ཚང་བོད་ཡིག་ཨང་བསྒྱུར།</h2>
    <div id="status" class="status">Loading...</div>
    <textarea id="input" placeholder="པཎྜི་ཏ་སོགས་འདི་ན་འཇུག་དགོས།..."></textarea>
    <div class="btn-box"><button onclick="doConvert()">ཧི་གཟུགས་སུ་བསྒྱུར།</button></div>
    <b>ཧི་གཟུགས་འོག་ནས་བཤུ་རོགས།(Unicode)</b>
    <textarea id="output" readonly></textarea>
</div>

<script>
    const mappingTable = new Map();
    let maxKeyLen = 1;

    async function init() {
        try {
            // 加上时间戳强制刷新，防止 GitHub 缓存旧文件
            const response = await fetch('tibet_master_map.json?v=' + Date.now());
            const data = await response.json();
            const keys = Object.keys(data);
            
            keys.forEach(k => {
                data[k].split('֮').forEach(p => {
                    const parts = p.split('֒');
                    if (parts.length === 2) {
                        mappingTable.set(parts[0], parts[1]);
                        if (parts[0].length > maxKeyLen) maxKeyLen = parts[0].length;
                    }
                });
            });
            document.getElementById('status').innerText = "✅ 就绪: " + mappingTable.size;
        } catch (e) {
            document.getElementById('status').innerText = "❌ 加载失败";
        }
    }

    function doConvert() {
        const inputVal = document.getElementById('input').value;
        if (!inputVal) return;
        
        let result = "";
        let i = 0;
        // 核心：强制从长到短匹配组合编码
        while (i < inputVal.length) {
            let matched = false;
            for (let len = Math.min(maxKeyLen, inputVal.length - i); len >= 1; len--) {
                let sub = inputVal.substring(i, i + len);
                if (mappingTable.has(sub)) {
                    result += mappingTable.get(sub);
                    i += len;
                    matched = true;
                    break;
                }
            }
            if (!matched) {
                result += inputVal[i];
                i++;
            }
        }
        document.getElementById('output').value = result;
    }
    init();
</script>
</body>
</html>
