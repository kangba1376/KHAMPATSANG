<!DOCTYPE html>
<html lang="bo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ཁམས་པ་ཚང་བོད་ཡིག་ཨང་བསྒྱུར།</title>
    <style>
        @font-face {
            font-family: 'TibetWildYak';
            src: url('TibetWildYak.ttf') format('truetype');
            font-display: swap;
        }

        body { 
            font-family: 'TibetWildYak', 'Microsoft YaHei', sans-serif; 
            padding: 20px; 
            background: #f0f2f5; 
            color: #1a1a1a; 
        }

        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
            text-align: center;
        }

        .logo {
            width: 120px;
            height: auto;
            margin-bottom: 15px;
            display: inline-block;
        }

        h2 { 
            color: #8B0000; 
            margin-bottom: 25px; 
            font-weight: 600; 
            font-size: 32px; 
            font-family: 'TibetWildYak', serif;
        }

        .section-label { 
            text-align: left;
            font-size: 16px; 
            color: #8B0000; 
            margin-bottom: 8px; 
            font-weight: bold; 
        }

        textarea { 
            width: 100%; 
            height: 200px; 
            margin-bottom: 20px; 
            padding: 15px; 
            font-size: 26px; 
            line-height: 1.8;
            border: 1px solid #d2d2d7; 
            border-radius: 8px; 
            resize: vertical; 
            box-sizing: border-box; 
            font-family: 'TibetWildYak', serif;
            background-color: #fafafa;
            color: #1a1a1a;
        }

        textarea:focus { 
            outline: none; 
            border-color: #8B0000; 
            box-shadow: 0 0 0 4px rgba(139, 0, 0, 0.1); 
            background-color: #fff;
        }

        .btns { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 25px; 
        }

        button { 
            flex: 1; 
            padding: 16px; 
            background: #8B0000; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 20px; 
            font-weight: 500; 
            transition: all 0.2s; 
            font-family: 'TibetWildYak', sans-serif;
        }

        button:hover { 
            background: #a00000; 
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div class="container">
    <img src="logo.png" alt="KhamPaTsang Logo" class="logo" onerror="this.style.display='none'">
    <h2>ཁམས་པ་ཚང་བོད་ཡིག་ཨང་བསྒྱུར།</h2>
    
    <div class="section-label">ནང་དོན་འགོད་ཁུལ། (པཎྜི་ཏ། ཡང་ན། ཧི་མ་ལ་ཡ།)</div>
    <textarea id="inputArea" placeholder="ཨང་བསྒྱུར་དགོས་པའི་ནང་དོན་འདི་ན་འགོད་རོགས།..."></textarea>
    
    <div class="btns">
        <button onclick="convert('toUni')">པཎྜི་ཏ། → ཧི་མ་ལ་ཡ།</button>
        <button onclick="convert('toBzd')">ཧི་མ་ལ་ཡ། → པཎྜི་ཏ།</button>
    </div>
    
    <div class="section-label">ཨང་བསྒྱུར་མཇུག་འབྲས།</div>
    <textarea id="outputArea" readonly placeholder="ཨང་བསྒྱུར་ཚར་བའི་ནང་དོན་འདི་ན་འཆར་འོང་།..."></textarea>
</div>

<script>
    let bzdToUniMap = new Map();

    // 1. 直接读取二进制 .tbl 文件
    async function loadTbl() {
        try {
            const response = await fetch('Bzd2Uni.tbl');
            const arrayBuffer = await response.arrayBuffer();
            const view = new DataView(arrayBuffer);

            // 假设 .tbl 结构是：2字节班智达码 -> 2字节Unicode码
            // 我们从头读到尾，每4个字节是一组映射
            for (let i = 0; i < view.byteLength; i += 4) {
                let bzd = view.getUint16(i, true);    // 小端字节序读取
                let uni = view.getUint16(i + 2, true);
                bzdToUniMap.set(bzd, uni);
            }
            console.log("TBL 码表直读成功，共加载映射：" + bzdToUniMap.size);
        } catch (err) {
            console.error("TBL 加载失败:", err);
        }
    }

    // 初始化加载
    loadTbl();

    function convert(direction) {
        let input = document.getElementById('inputArea').value;
        let output = "";

        if (direction === 'toUni') {
            for (let i = 0; i < input.length; i++) {
                let code = input.charCodeAt(i);
                
                // 核心逻辑：自动尝试多种可能的编码映射
                // 1. 直接匹配
                // 2. 移除私有区偏移 (0xF000) 后匹配
                let realBzd = code >= 0xF000 ? (code - 0xF000) : code;

                if (bzdToUniMap.has(realBzd)) {
                    output += String.fromCharCode(bzdToUniMap.get(realBzd));
                } else {
                    // 如果找不到，尝试保留原样（处理空格、标点等）
                    output += input[i];
                }
            }
        } else {
            output = "反向转换正在根据 TBL 逻辑优化中...";
        }
        document.getElementById('outputArea').value = output;
    }
</script>

</body>
</html>
