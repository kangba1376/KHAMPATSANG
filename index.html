<!DOCTYPE html>
<html lang="bo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ཁམས་པ་ཚང་བོད་ཡིག་ཨང་བསྒྱུར།</title>
    <style>
        @font-face {
            font-family: 'TibetWildYak';
            src: url('TibetWildYak.ttf') format('truetype');
            font-display: swap;
        }

        body { 
            font-family: 'TibetWildYak', 'Microsoft YaHei', sans-serif; 
            padding: 20px; 
            background: #f0f2f5; 
            color: #1a1a1a; 
        }

        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
            text-align: center;
        }

        .logo {
            width: 120px;
            height: auto;
            margin-bottom: 15px;
            display: inline-block;
        }

        h2 { 
            color: #8B0000; 
            margin-bottom: 25px; 
            font-weight: 600; 
            font-size: 32px; 
            font-family: 'TibetWildYak', serif;
        }

        .section-label { 
            text-align: left;
            font-size: 16px; 
            color: #8B0000; 
            margin-bottom: 8px; 
            font-weight: bold; 
        }

        textarea { 
            width: 100%; 
            height: 200px; 
            margin-bottom: 20px; 
            padding: 15px; 
            font-size: 26px; 
            line-height: 1.8;
            border: 1px solid #d2d2d7; 
            border-radius: 8px; 
            resize: vertical; 
            box-sizing: border-box; 
            font-family: 'TibetWildYak', serif;
            background-color: #fafafa;
            color: #1a1a1a;
        }

        textarea:focus { 
            outline: none; 
            border-color: #8B0000; 
            box-shadow: 0 0 0 4px rgba(139, 0, 0, 0.1); 
            background-color: #fff;
        }

        .btns { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 25px; 
        }

        button { 
            flex: 1; 
            padding: 16px; 
            background: #8B0000; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 20px; 
            font-weight: 500; 
            transition: all 0.2s; 
            font-family: 'TibetWildYak', sans-serif;
        }

        button:hover { 
            background: #a00000; 
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div class="container">
    <img src="logo.png" alt="KhamPaTsang Logo" class="logo" onerror="this.style.display='none'">
    <h2>ཁམས་པ་ཚང་བོད་ཡིག་ཨང་བསྒྱུར།</h2>
    
    <div class="section-label">ནང་དོན་འགོད་ཁུལ། (པཎྜི་ཏ། ཡང་ན། ཧི་མ་ལ་ཡ།)</div>
    <textarea id="inputArea" placeholder="ཨང་བསྒྱུར་དགོས་པའི་ནང་དོན་འདི་ན་འགོད་རོགས།..."></textarea>
    
    <div class="btns">
        <button onclick="convert('toUni')">པཎྜི་ཏ། → ཧི་མ་ལ་ཡ།</button>
        <button onclick="convert('toBzd')">ཧི་མ་ལ་ཡ། → པཎྜི་ཏ།</button>
    </div>
    
    <div class="section-label">ཨང་བསྒྱུར་མཇུག་འབྲས།</div>
    <textarea id="outputArea" readonly placeholder="ཨང་བསྒྱུར་ཚར་བའི་ནང་དོན་འདི་ན་འཆར་འོང་།..."></textarea>
</div>

<script>
    let bzdMap = new Map();
    let cp936Map = new Map();

    async function init() {
        try {
            // 必须确保这两个文件和 convert.html 在同一个 KHAMPATSANG 文件夹下
            const [cpRes, tblRes] = await Promise.all([
                fetch('CP936toUnicodeTable.TXT'),
                fetch('Bzd2Uni.tbl')
            ]);
            
            const cpText = await cpRes.text();
            cpText.split('\n').forEach(l => {
                const p = l.split('\t');
                if (p.length >= 2) cp936Map.set(parseInt(p[1], 16), parseInt(p[0], 16));
            });

            const tblText = await tblRes.text();
            tblText.split('\n').forEach(l => {
                const p = l.trim().split(/\s+/);
                if (p.length >= 2) bzdMap.set(p[0], p.slice(1).map(v => String.fromCharCode(parseInt(v))).join(''));
            });
            console.log("康巴仓，转码引擎已就绪！");
        } catch (e) { console.error("加载码表失败，请检查文件是否存在", e); }
    }

    init();

    function convert(direction) {
        let input = document.getElementById('inputArea').value;
        let output = "";
        if (direction === 'toUni') {
            for (let i = 0; i < input.length; i++) {
                let code = input.charCodeAt(i);
                // 1. 修正乱码
                let raw = cp936Map.get(code) || code;
                // 2. 查班智达表 (同时兼容 0xF000 偏移量)
                let res = bzdMap.get(raw.toString()) || bzdMap.get((raw - 61440).toString());
                output += res ? res : input[i];
            }
        }
        document.getElementById('outputArea').value = output;
    }
</script>

</body>
</html>
